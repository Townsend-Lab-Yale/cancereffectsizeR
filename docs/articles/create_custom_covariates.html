<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="cancereffectsizeR">
<title>Generate tissue covariates data • cancereffectsizeR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Generate tissue covariates data">
<meta property="og:description" content="cancereffectsizeR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">cancereffectsizeR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/cancereffectsizeR.html">Tutorial</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/MAF_filtering_tips.html">MAF filtering and sample validation</a>
    <a class="dropdown-item" href="../articles/cosmic_cancer_type_note.html">Cancer type considerations for COSMIC signature extraction</a>
    <a class="dropdown-item" href="../articles/create_custom_covariates.html">Generate tissue covariates data</a>
    <a class="dropdown-item" href="../articles/custom_refset_instructions.html">Running with custom reference data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Townsend-Lab-Yale/cancereffectsizeR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Generate tissue covariates data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Townsend-Lab-Yale/cancereffectsizeR/blob/main/vignettes/create_custom_covariates.Rmd" class="external-link"><code>vignettes/create_custom_covariates.Rmd</code></a></small>
      <div class="d-none name"><code>create_custom_covariates.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Covariates data specific to a tissue, cancer, or cell type improves
the mutation rate estimates produced by
<code><a href="../reference/gene_mutation_rates.html">gene_mutation_rates()</a></code>. This guide shows how to generate
covariates from experimental data by walking through the creation of the
lung tissue covariates offered in version 1.0 of the cancereffectsizeR
data package <a href="https://github.com/Townsend-Lab-Yale/ces.refset.hg19" class="external-link">ces.refset.hg19</a>.
The source data includes RNA-Seq, histone mark, and replication timing
data. The data files are large and can be downloaded from their
respective project websites. Note that new versions of some of these
data files are available and will possibly be used in future updates to
ces.refset.hg19.</p>
<p>Presumably, if you are going to the trouble of generating your own
covariates data, your data sources, tissue type, genome build, or even
species varies from this example. If you read through the code line by
line, it will hopefully be apparent what changes need to be made for
compatibility with your data. Please don’t hesitate to contact us with
questions.</p>
<p>The key task is to associate the genes defined in your refset
(whether ces.refset.hg19, or some custom refset) with the information in
your data sources. Usually, this means either matching up gene
identifiers or lining up genes with their genomic positions. In the
latter case, be sure the genome build of the experimental data matches
that used in the refset. (If it doesn’t, you may be able to convert it
using a tool such as liftOver.)</p>
<p>Note that if you run through this code exactly with all the same
source data, the output covariates data will still differ slightly from
the ces.refset.hg19 lung data because of improvements to the
workflow.</p>
</div>
<div class="section level2">
<h2 id="example-lung-tissue-covariates-for-ces-refset-hg19">Example: Lung tissue covariates for ces.refset.hg19<a class="anchor" aria-label="anchor" href="#example-lung-tissue-covariates-for-ces-refset-hg19"></a>
</h2>
<p>Start by loading required packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rtracklayer</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/GenomicRanges" class="external-link">GenomicRanges</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Load refset data package, if not using a custom refset directory</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ces.refset.hg19</span><span class="op">)</span></span></code></pre></div>
<p>We need to gather gene information used by the refset of interest. If
using a custom refset directory, use <code>readRDS</code> to load the
required RefCDS and gr_genes data; here, we can access the data from the
refset environment:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get gene names and gene IDs; remove version number suffixes for short IDs</span></span>
<span><span class="va">refset_genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ces.refset.hg19</span><span class="op">$</span><span class="va">RefCDS</span>, <span class="st">'['</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gene_id"</span>, <span class="st">"gene_name"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">refset_genes</span><span class="op">[</span>, <span class="va">short_gene_id</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">'\\..*'</span>, <span class="st">''</span>, <span class="va">gene_id</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">refset_genes</span>, <span class="st">"short_gene_id"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get genomic intervals for each gene</span></span>
<span><span class="va">gene_gr</span> <span class="op">=</span> <span class="va">ces.refset.hg19</span><span class="op">$</span><span class="va">gr_genes</span></span></code></pre></div>
<p>Next, we’ll load and process the experimental data. Since some
processing steps can be time-consuming, you may wish to use
<code>saveRDS</code> to save processed data as you go, in case you need
to repeat the workflow.</p>
<div class="section level3">
<h3 id="process-gene-based-experimental-data">Process gene-based experimental data<a class="anchor" aria-label="anchor" href="#process-gene-based-experimental-data"></a>
</h3>
<p>First, we’ll load lung tissue RNA-Seq gene-level read counts from
GTEx (Genotype-Tissue expression project). The data file is large
because it contains many tissue types. We’ll use an accompanying sample
attributes file to subset to lung samples.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtex</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">"GTEx_Analysis_2016-01-15_v7_RNASeQCv1.1.8_gene_tpm.gct.gz"</span><span class="op">)</span></span>
<span><span class="va">gtex_key</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">"GTEx_v7_Annotations_SampleAttributesDS.txt"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subset to lung samples</span></span>
<span><span class="va">gtex_lung_samples</span> <span class="op">=</span> <span class="va">gtex_key</span><span class="op">[</span><span class="va">SMTSD</span> <span class="op">==</span> <span class="st">"Lung"</span>, <span class="va">SAMPID</span><span class="op">]</span></span>
<span><span class="va">gtex_lung_samples</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">gtex_lung_samples</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">gtex</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gtex</span> <span class="op">=</span> <span class="va">gtex</span><span class="op">[</span>, <span class="va">.SD</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Name"</span>, <span class="va">gtex_lung_samples</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># The GTEx Ensembl gene IDs (in "Name") include version suffixes; strip these for short IDs</span></span>
<span><span class="va">gtex</span><span class="op">[</span>, <span class="va">short_gene_id</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">'\\..*'</span>, <span class="st">''</span>, <span class="va">Name</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">gtex</span><span class="op">[</span>, <span class="va">Name</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Consider saving work in progress with saveRDS(gtex, "my_gtex.rds")</span></span></code></pre></div>
<p>We repeat this process with cancer cell line RNA-Seq data from
DepMap’s CCLE (Cancer Cell Line Encyclopedia). As above, the data file
contains many tissue types, and we subset to lung samples.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ccle</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">"CCLE_DepMap_18Q1_RNAseq_RPKM_20180214.gct"</span><span class="op">)</span></span>
<span><span class="va">ccle_lung_samples</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ccle</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ccle</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"lung"</span>, ignore.case <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">ccle</span> <span class="op">=</span> <span class="va">ccle</span><span class="op">[</span>, <span class="va">.SD</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Name"</span>, <span class="va">ccle_lung_samples</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># The CCLE Ensembl gene IDs (in "Name") include version suffixes; strip these for short IDs</span></span>
<span><span class="va">ccle</span><span class="op">[</span>, <span class="va">short_gene_id</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">'\\..*'</span>, <span class="st">''</span>, <span class="va">Name</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">ccle</span><span class="op">[</span>, <span class="va">Name</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="process-position-based-experimental-data">Process position-based experimental data<a class="anchor" aria-label="anchor" href="#process-position-based-experimental-data"></a>
</h3>
<p>We will use histone mark data from Roadmap Epigenomics.</p>
<p>First, the data should be converted from Wig to BigWig format. It’s
possible to do this outside of R with other utilities, but we’ll show
how to do it in R. This will result in the creation of new data files
with the “.bw” extension. They will be significantly larger than the
.wig.gz files, so you may want to delete them later.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">marks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GSM1013123_UCSD.Lung.H3K27ac.STL001.wig.gz"</span>,</span>
<span>          <span class="st">"GSM1059437_UCSD.Lung.H3K36me3.STL001.wig.gz"</span>,</span>
<span>          <span class="st">"GSM1059443_UCSD.Lung.H3K4me1.STL001.wig.gz"</span>,</span>
<span>          <span class="st">"GSM1120355_UCSD.Lung.H3K9me3.STL001.wig.gz"</span>,</span>
<span>          <span class="st">"GSM906395_UCSD.Lung.H3K27ac.STL002.wig.gz"</span>,</span>
<span>          <span class="st">"GSM906411_UCSD.Lung.H3K9me3.STL002.wig.gz"</span>,</span>
<span>          <span class="st">"GSM910572_UCSD.Lung.H3K4me1.STL002.wig.gz"</span>,</span>
<span>          <span class="st">"GSM915336_UCSD.Lung.H3K4me3.STL002.wig.gz"</span>,</span>
<span>          <span class="st">"GSM956014_UCSD.Lung.H3K36me3.STL002.wig.gz"</span><span class="op">)</span></span>
<span><span class="va">hg19_seqinfo</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomeInfoDb/man/seqinfo.html" class="external-link">seqinfo</a></span><span class="op">(</span><span class="va">BSgenome.Hsapiens.UCSC.hg19</span><span class="op">)</span> <span class="co"># or, whatever genome you're using</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">marks</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">bw</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rtracklayer/man/wigToBigWig.html" class="external-link">wigToBigWig</a></span><span class="op">(</span><span class="va">marks</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, seqinfo <span class="op">=</span> <span class="va">hg19_seqinfo</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Finished "</span>, <span class="va">marks</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"."</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># BigWig-formatted files have names based on originals</span></span>
<span><span class="va">bw</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">'.wig.gz'</span>, <span class="st">'.bw'</span>, <span class="va">marks</span><span class="op">)</span></span></code></pre></div>
<p>Now, we can load each converted data file as a GRanges object, with a
score annotation that indicates the level of enrichment of the given
histone mark in each equally-sized genomic interval. We will assign
scores to each gene based on the average score across all overlapping
genomic intervals.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">marks_by_gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>gene_name <span class="op">=</span> <span class="va">refset_genes</span><span class="op">$</span><span class="va">gene_name</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bw</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mark_gr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rtracklayer/man/BigWigFile.html" class="external-link">import.bw</a></span><span class="op">(</span><span class="va">bw</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/GenomeInfoDb/man/seqlevelsStyle.html" class="external-link">seqlevelsStyle</a></span><span class="op">(</span><span class="va">mark_gr</span><span class="op">)</span> <span class="op">=</span> <span class="st">"NCBI"</span> <span class="co"># to match ces.refset.hg19's gene_gr</span></span>
<span>  <span class="va">overlaps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/findOverlaps-methods.html" class="external-link">findOverlaps</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">mark_gr</span>, subject <span class="op">=</span> <span class="va">gene_gr</span><span class="op">)</span></span>
<span>  <span class="va">overlaps_dt</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>chromatin_hits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Hits-class.html" class="external-link">queryHits</a></span><span class="op">(</span><span class="va">overlaps</span><span class="op">)</span>,gene_hits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Hits-class.html" class="external-link">subjectHits</a></span><span class="op">(</span><span class="va">overlaps</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">overlaps_dt</span><span class="op">[</span>, <span class="va">gene_name</span> <span class="op">:=</span> <span class="va">gene_gr</span><span class="op">$</span><span class="va">names</span><span class="op">[</span><span class="va">gene_hits</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">overlaps_dt</span><span class="op">[</span>, <span class="va">score</span> <span class="op">:=</span> <span class="va">mark_gr</span><span class="op">$</span><span class="va">score</span><span class="op">[</span><span class="va">chromatin_hits</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">score_by_gene</span> <span class="op">=</span> <span class="va">overlaps_dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">score</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"gene_name"</span><span class="op">]</span></span>
<span>  <span class="va">current_mark</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">'.bw'</span>, <span class="st">''</span>, <span class="va">bw</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">marks_by_gene</span><span class="op">[</span><span class="va">score_by_gene</span>, <span class="op">(</span><span class="va">current_mark</span><span class="op">)</span> <span class="op">:=</span> <span class="va">mean_score</span>, on <span class="op">=</span> <span class="st">"gene_name"</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Finished "</span>, <span class="va">bw</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"."</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Fill entries with no data (i.e., no chromatin marks) with zeroes</span></span>
<span><span class="va">marks_by_gene</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">marks_by_gene</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Considering saving: saveRDS(marks_by_gene, "marks_by_gene.rds")</span></span></code></pre></div>
<p>Finally, we will use replication timing data from ReplicationDomain,
processed nearly identically:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_timing</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RT_IMR90_Lung Fibroblast_Int49605910_hg19.bedgraph"</span>,</span>
<span>               <span class="st">"RT_IMR90_Lung Fibroblast_Int78679848_hg19.bedgraph"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rt_by_gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>gene_name <span class="op">=</span> <span class="va">refset_genes</span><span class="op">$</span><span class="va">gene_name</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">rep_timing</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rt_gr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rtracklayer/man/BEDFile-class.html" class="external-link">import.bedGraph</a></span><span class="op">(</span><span class="va">rep_timing</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/GenomeInfoDb/man/seqlevelsStyle.html" class="external-link">seqlevelsStyle</a></span><span class="op">(</span><span class="va">rt_gr</span><span class="op">)</span> <span class="op">=</span> <span class="st">"NCBI"</span> <span class="co"># to match ces.refset.hg19's gene_gr</span></span>
<span>  <span class="va">overlaps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/findOverlaps-methods.html" class="external-link">findOverlaps</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">rt_gr</span>, subject <span class="op">=</span> <span class="va">gene_gr</span><span class="op">)</span></span>
<span>  <span class="va">overlaps_dt</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>rt_hits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Hits-class.html" class="external-link">queryHits</a></span><span class="op">(</span><span class="va">overlaps</span><span class="op">)</span>,gene_hits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Hits-class.html" class="external-link">subjectHits</a></span><span class="op">(</span><span class="va">overlaps</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">overlaps_dt</span><span class="op">[</span>, <span class="va">gene_name</span> <span class="op">:=</span> <span class="va">gene_gr</span><span class="op">$</span><span class="va">names</span><span class="op">[</span><span class="va">gene_hits</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">overlaps_dt</span><span class="op">[</span>, <span class="va">score</span> <span class="op">:=</span> <span class="va">rt_gr</span><span class="op">$</span><span class="va">score</span><span class="op">[</span><span class="va">rt_hits</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">score_by_gene</span> <span class="op">=</span> <span class="va">overlaps_dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">score</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"gene_name"</span><span class="op">]</span></span>
<span>  <span class="va">current_rt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">'_hg19.bedgraph'</span>, <span class="st">''</span>, <span class="va">rep_timing</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">rt_by_gene</span><span class="op">[</span><span class="va">score_by_gene</span>, <span class="op">(</span><span class="va">current_rt</span><span class="op">)</span> <span class="op">:=</span> <span class="va">mean_score</span>, on <span class="op">=</span> <span class="st">"gene_name"</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Finished "</span>, <span class="va">rep_timing</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"."</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Fill in zeroes for genes with no RT data</span></span>
<span><span class="va">rt_by_gene</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">rt_by_gene</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combine-processed-data-and-run-prcomp">Combine processed data and run <em>prcomp</em><a class="anchor" aria-label="anchor" href="#combine-processed-data-and-run-prcomp"></a>
</h3>
<p>We combine information across all refset genes that were present in
all gene-based data sources. (Position-based data, such as the chromatin
and replication timing data, are presumed to cover all genes.)</p>
<p>[Aside: refset genes that are not present in all gene-based data
sources will not have any covariates data generated, and
cancereffectsizeR’s <code><a href="../reference/gene_mutation_rates.html">gene_mutation_rates()</a></code> will instead use
covariates of the nearest available gene. In this example, over 95% of
refset.ces.hg19 genes are covered in both CCLE and GTEx data. If you
want to use a gene-based data source that leaves out many genes, you may
want to adopt another strategy, such as manually inserting an
appropriate value for missing genes, or using the values of nearby
genes.]</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_gene_ids</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">intersect</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">refset_short_gene_ids</span>, <span class="va">ccle</span><span class="op">$</span><span class="va">short_gene_id</span>, <span class="va">gtex</span><span class="op">$</span><span class="va">short_gene_id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariates_input</span> <span class="op">=</span> <span class="va">refset_genes</span><span class="op">[</span><span class="va">final_gene_ids</span>, <span class="fu">.</span><span class="op">(</span><span class="va">short_gene_id</span>, <span class="va">gene_name</span><span class="op">)</span>, on <span class="op">=</span> <span class="st">"short_gene_id"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Merge all data for the chosen gene IDs</span></span>
<span><span class="va">covariates_input</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">merge.data.table</a></span><span class="op">(</span><span class="va">covariates_input</span>, <span class="va">gtex</span>, all.x <span class="op">=</span> <span class="cn">T</span>, all.y <span class="op">=</span> <span class="cn">F</span>, by <span class="op">=</span> <span class="st">"short_gene_id"</span><span class="op">)</span></span>
<span><span class="va">covariates_input</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">merge.data.table</a></span><span class="op">(</span><span class="va">covariates_input</span>, <span class="va">ccle</span>, all.x <span class="op">=</span> <span class="cn">T</span>, all.y <span class="op">=</span> <span class="cn">F</span>, by <span class="op">=</span> <span class="st">"short_gene_id"</span><span class="op">)</span></span>
<span><span class="va">covariates_input</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">merge.data.table</a></span><span class="op">(</span><span class="va">covariates_input</span>, <span class="va">marks_by_gene</span>, all.x <span class="op">=</span> <span class="cn">T</span>, all.y <span class="op">=</span> <span class="cn">F</span>, by <span class="op">=</span> <span class="st">"gene_name"</span><span class="op">)</span></span>
<span><span class="va">covariates_input</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">merge.data.table</a></span><span class="op">(</span><span class="va">covariates_input</span>, <span class="va">rt_by_gene</span>, all.x <span class="op">=</span> <span class="cn">T</span>, all.y <span class="op">=</span> <span class="cn">F</span>, by <span class="op">=</span> <span class="st">"gene_name"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># drop any data columns with no variance (none, if using the example data)</span></span>
<span><span class="va">has_variance</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">covariates_input</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">uniqueN</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">columns_with_variance</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">has_variance</span><span class="op">)</span><span class="op">[</span><span class="va">has_variance</span><span class="op">]</span></span>
<span><span class="va">covariates_input</span> <span class="op">=</span> <span class="va">covariates_input</span><span class="op">[</span>, <span class="va">..columns_with_variance</span><span class="op">]</span></span></code></pre></div>
<p>We finish by running the PCA function <em>prcomp</em> to generate a
prcomp-class object, which contains the covariates information used by
cancereffectsizeR, and saving the object.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># To format for prcomp, convert to a data-only matrix and transpose</span></span>
<span><span class="va">final_gene_names</span> <span class="op">=</span> <span class="va">covariates_input</span><span class="op">$</span><span class="va">gene_name</span></span>
<span><span class="va">covariates_input</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">covariates_input</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gene_name"</span>, <span class="st">"short_gene_id"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">covariates_input</span><span class="op">)</span> <span class="op">=</span> <span class="va">final_gene_names</span></span>
<span></span>
<span><span class="co"># Run prcomp (with specification of 20 principal components and data scaling)</span></span>
<span><span class="va">covariates_output</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">covariates_input</span>, rank. <span class="op">=</span> <span class="fl">20</span>, scale. <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save it!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">covariates_output</span>, <span class="st">"lung.rds"</span><span class="op">)</span></span></code></pre></div>
<p>The resulting covariates RDS file can be placed in a <a href="custom_refset_instructions.html">custom refset directory</a>, or
it can be loaded into an R session with <code>readRDS</code> and passed
directly to <code><a href="../reference/gene_mutation_rates.html">gene_mutation_rates()</a></code>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Vincent L. Cannataro, Jeff Mandell.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
